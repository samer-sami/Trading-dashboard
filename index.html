<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark light" />
    <title>Trading Dashboard</title>

    <!-- Performance: preconnects -->
    <link rel="preconnect" href="https://s3.tradingview.com" />
    <link rel="dns-prefetch" href="https://s3.tradingview.com" />
    <link rel="preconnect" href="https://widgets.tradingview-widget.com" />
    <link rel="dns-prefetch" href="https://widgets.tradingview-widget.com" />
    <link rel="preconnect" href="https://fxverify.com" />
    <link rel="dns-prefetch" href="https://fxverify.com" />

    <!-- (Optional) RSS proxy endpoints used by the News module -->
    <link rel="preconnect" href="https://api.allorigins.win" />
    <link rel="dns-prefetch" href="https://api.allorigins.win" />
    <link rel="preconnect" href="https://api.codetabs.com" />
    <link rel="dns-prefetch" href="https://api.codetabs.com" />

    <!-- Tailwind CDN runtime -->
    <script defer src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg-primary: #0a0e17;
        --bg-secondary: #111827;
        --bg-tertiary: #1f2937;
        --bg-card: #151c2c;
        --border-color: #2d3748;
        --border-light: #374151;
        --text-primary: #fbfbfc;
        --text-secondary: #9ca3af;
        --text-muted: #6b7280;
        --accent-blue: #3b82f6;
        --accent-green: #10b981;
        --accent-red: #ef4444;
        --accent-yellow: #f59e0b;
        --accent-purple: #8b5cf6;

        --dock-w: 42px;
        --dock-h: 56px; /* mobile bottom bar height */
        --topbar-height: 42px;
        --topbar-bg: #0b0f1a;
        --topbar-border: rgba(255, 255, 255, 0.12);
        --anim: 0.12s;

        --news-font-scale: 1;
        --calendar-text: #ffffff;
        --news-text: #f9fafb;
        --news-text-secondary: #e5e7eb;
        --news-text-muted: #d1d5db;

        --zoom-comp: 1;

        /* Dynamic calendar sizing computed by JS */
        --calendar-sessions-h: 190px;

        /* Focus ring */
        --focus-ring: rgba(59, 130, 246, 0.35);
      }

      [data-theme="light"] {
        --bg-primary: #f3f4f6;
        --bg-secondary: #ffffff;
        --bg-tertiary: #e5e7eb;
        --bg-card: #ffffff;
        --border-color: #d1d5db;
        --border-light: #e5e7eb;
        --text-primary: #111827;
        --text-secondary: #4b5563;
        --text-muted: #9ca3af;
        --topbar-bg: #ffffff;
        --topbar-border: rgba(17, 24, 39, 0.12);
        --calendar-text: #000000;
        --news-text: #111827;
        --news-text-secondary: #111827;
        --news-text-muted: #374151;
        --focus-ring: rgba(59, 130, 246, 0.25);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        overflow: hidden;
        padding-top: var(--topbar-height);
      }

      /* Accessibility */
      :focus-visible {
        outline: 2px solid var(--accent-blue);
        outline-offset: 2px;
        border-radius: 6px;
      }

      ::-webkit-scrollbar {
        width: 5px;
        height: 5px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--border-light);
      }

      /* Topbar */
      .topbar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: var(--topbar-height);
        background: var(--topbar-bg);
        border-bottom: 1px solid var(--topbar-border);
        z-index: 9999;
        overflow: hidden;
        display: flex;
        align-items: center;
        padding-right: var(--dock-w);
        contain: layout paint;
      }

      .ticker-viewport {
        width: 100%;
        height: 100%;
        overflow: hidden;
        padding: 0 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        contain: layout paint;
      }

      .ticker-strip {
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        gap: 6px;
        transform-origin: center center;
        will-change: transform;
      }

      .ticker-loading {
        font-size: 12px;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .ticker-loading-spinner {
        width: 14px;
        height: 14px;
        border: 2px solid var(--border-color);
        border-top-color: var(--accent-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      tv-ticker-tag {
        display: inline-block;
        flex: 0 0 auto;
        cursor: pointer;
      }

      /* Dock (desktop sidebar) */
      .dock {
        position: fixed;
        right: 0;
        top: var(--topbar-height);
        bottom: 0;
        width: var(--dock-w);
        background: var(--bg-secondary);
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        z-index: 300;
        padding: 6px;
      }

      .dock-section {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .dock-section + .dock-section {
        margin-top: auto;
        padding-top: 6px;
        border-top: 1px solid var(--border-color);
      }

      .dock-sep {
        width: 100%;
        height: 1px;
        background: var(--border-color);
        margin: 4px 0;
      }

      .dock-btn {
        width: 100%;
        aspect-ratio: 1;
        border: none;
        border-radius: 6px;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all var(--anim);
        position: relative;
      }

      .dock-btn:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }

      .dock-btn.active {
        background: var(--accent-blue);
        color: white;
      }

      .dock-btn .icon {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        fill: none;
        stroke-width: 1.8;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      .dock-tooltip {
        position: absolute;
        right: calc(100% + 6px);
        top: 50%;
        transform: translateY(-50%);
        background: var(--bg-tertiary);
        color: var(--text-primary);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--anim);
        border: 1px solid var(--border-color);
        z-index: 1000;
      }

      .dock-btn:hover .dock-tooltip {
        opacity: 1;
      }

      .mobile-only {
        display: none;
      }

      /* Main */
      main {
        position: fixed;
        top: var(--topbar-height);
        left: 0;
        right: var(--dock-w);
        bottom: 0;
        overflow-y: auto;
        background: var(--bg-primary);
        z-index: 1;
        scroll-behavior: smooth;
      }

      /* Charts */
      .chart-section {
        width: 100%;
        height: calc(100vh - var(--topbar-height));
        display: flex;
        flex-direction: column;
      }

      .chart-row {
        flex: 1;
        display: flex;
        min-height: 0;
        position: relative;
      }

      .chart-row-anchor {
        position: absolute;
        top: 0;
        left: 0;
        width: 1px;
        height: 1px;
        pointer-events: none;
      }

      .chart-cell {
        flex: 1;
        position: relative;
        border: 1px solid var(--border-color);
        margin: -0.5px;
        overflow: hidden;
        background: var(--bg-card);
        contain: content;
      }

      .chart-host,
      .chart-host .tradingview-widget-container,
      .chart-host .tradingview-widget-container__widget {
        width: 100%;
        height: 100%;
      }

      /* Watermark + TF square row */
      .wm-row {
        position: absolute;
        top: 3px;
        left: 3px;
        z-index: 12;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        pointer-events: auto;
      }

      .watermark {
        z-index: 10;
        font-size: 10px;
        font-weight: 600;
        color: var(--text-primary);
        cursor: pointer;
        background: var(--bg-secondary);
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
        transition: all var(--anim);
        line-height: 1;
        user-select: none;
      }

      .watermark:hover {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: white;
      }

      .watermark .tf {
        font-size: 9px;
        margin-left: 4px;
        opacity: 0.7;
      }

      .tf-square {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        z-index: 12;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        font-weight: 700;
        color: var(--text-primary);
        cursor: pointer;
        user-select: none;
        transition: all var(--anim);
        line-height: 1;
        flex: 0 0 auto;
      }

      .tf-square:hover {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: white;
      }

      /* Panel */
      .panel {
        position: fixed;
        top: var(--topbar-height);
        right: var(--dock-w);
        height: calc(100vh - var(--topbar-height));
        width: 75%;
        background: var(--bg-secondary);
        border-left: 1px solid var(--border-color);
        z-index: 250;
        transform: translateX(100%);
        transition: transform var(--anim) ease;
        display: flex;
        flex-direction: column;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
        pointer-events: auto;
        min-width: 320px;
      }

      .panel.open {
        transform: translateX(0);
      }

      .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-tertiary);
        gap: 10px;
      }

      .panel-title {
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 0;
        flex: 1 1 auto;
      }

      .panel-title .icon {
        width: 16px;
        height: 16px;
        stroke: var(--accent-blue);
        fill: none;
        stroke-width: 1.8;
        flex: 0 0 auto;
      }

      .close-btn {
        width: 26px;
        height: 26px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all var(--anim);
        flex: 0 0 auto;
      }

      .close-btn:hover {
        background: var(--accent-red);
        border-color: var(--accent-red);
        color: white;
      }

      .panel-body {
        flex: 1;
        overflow: hidden;
        padding: 0;
        background: var(--bg-secondary);
      }

      /* Calendar */
      .calendar-container {
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: var(--bg-secondary);
      }

      /* upper calendar scrollable */
      .calendar-section {
        flex: 1 1 auto;
        min-height: 0;
        overflow: auto; /* changed: allows scrolling in upper calendar area */
        background: var(--bg-secondary);
        position: relative;
      }

      .sessions-section {
        flex: 0 0 auto;
        height: var(--calendar-sessions-h);
        padding: 6px 8px 6px; /* minimal spacing */
        border-top: 1px solid var(--border-color);
        background: var(--bg-tertiary);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 140px;
      }

      #sessionContainer {
        flex: 1 1 auto;
        min-height: 0;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding-right: 2px;
      }

      .session-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .session-label {
        width: calc(94px * var(--zoom-comp));
        min-width: calc(82px * var(--zoom-comp));
        font-size: calc(11px * var(--zoom-comp));
        font-weight: 700;
        color: var(--text-secondary);
        display: flex;
        flex-direction: column;
        line-height: 1.05;
      }

      .session-label .time {
        font-size: calc(10px * var(--zoom-comp));
        color: var(--text-muted);
        font-variant-numeric: tabular-nums;
        font-weight: 600;
      }

      .session-bar-container {
        flex: 1;
        height: calc(18px * var(--zoom-comp));
        min-height: 14px;
        background: var(--bg-secondary);
        border-radius: 6px;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }

      .session-bar {
        position: absolute;
        height: 100%;
        font-size: calc(10px * var(--zoom-comp));
        font-weight: 700;
        color: white;
        transition: all var(--anim);
      }

      .session-bar.sydney {
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
      }
      .session-bar.tokyo {
        background: linear-gradient(90deg, #ef4444, #f87171);
      }
      .session-bar.london {
        background: linear-gradient(90deg, #10b981, #34d399);
      }
      .session-bar.newyork {
        background: linear-gradient(90deg, #f59e0b, #fbbf24);
      }

      .session-bar.inactive {
        opacity: 0.3;
      }

      .time-marker {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--accent-red);
        z-index: 10;
      }

      .time-marker::before {
        content: attr(data-time);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--accent-red);
        color: white;
        font-size: calc(9px * var(--zoom-comp));
        padding: 1px 5px;
        border-radius: 6px;
        white-space: nowrap;
        font-weight: 800;
      }

      .hour-labels {
        flex: 0 0 auto;
        display: flex;
        justify-content: space-between;
        margin-top: 4px; /* minimal spacing */
        padding-left: calc(102px * var(--zoom-comp));
        gap: 6px;
      }

      .hour-labels span {
        font-size: calc(10px * var(--zoom-comp));
        color: var(--text-muted);
        font-weight: 700;
      }

      #economic-calendar-widget {
        height: 100%;
        width: 100%;
        background: var(--bg-secondary);
        position: relative;
      }

      .calendar-container .session-label,
      .calendar-container .session-label .time,
      .calendar-container .hour-labels span,
      .calendar-container .local-clock {
        color: var(--calendar-text) !important;
      }

      .local-clock {
        flex: 0 0 auto;
        text-align: center;
        font-weight: 900;
        line-height: 1.1;
        font-size: calc(14px * var(--zoom-comp));
        margin: 0 0 4px; /* minimal spacing */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        letter-spacing: 0.2px;
      }

      /* News */
      .news-container {
        height: 100%;
        display: flex;
        flex-direction: column;
        background: var(--bg-secondary);
      }

      .news-header {
        padding: 12px;
        background: linear-gradient(180deg, var(--bg-tertiary), rgba(0, 0, 0, 0));
        border-bottom: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex: 0 0 auto;
      }

      .news-header-row1 {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }

      .news-tabs {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px;
        border: 1px solid var(--border-color);
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.08);
      }

      .tab-btn {
        padding: 6px 10px;
        border: none;
        border-radius: 999px;
        background: transparent;
        color: var(--text-secondary);
        font-size: calc(12px * var(--news-font-scale));
        font-weight: 800;
        cursor: pointer;
        transition: all var(--anim);
        line-height: 1;
        user-select: none;
      }

      .tab-btn:hover {
        color: var(--text-primary);
        background: rgba(59, 130, 246, 0.08);
      }

      .tab-btn.active {
        color: white;
        background: var(--accent-blue);
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.18);
      }

      .news-status-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border: 1px solid var(--border-color);
        border-radius: 999px;
        background: rgba(17, 24, 39, 0.55);
        color: var(--news-text-muted);
        font-size: calc(11px * var(--news-font-scale));
        font-weight: 700;
        min-width: 220px;
      }

      [data-theme="light"] .news-status-pill {
        background: rgba(255, 255, 255, 0.7);
      }

      .news-controls {
        display: flex;
        align-items: center;
        gap: 6px;
        flex: 0 0 auto;
        flex-wrap: wrap;
      }

      .news-btn {
        padding: 7px 10px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        font-size: calc(12px * var(--news-font-scale));
        color: var(--news-text);
        cursor: pointer;
        transition: all var(--anim);
        line-height: 1;
        font-weight: 800;
      }

      .news-btn:hover {
        background: var(--bg-card);
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px var(--focus-ring);
      }

      .news-btn.toggled {
        border-color: var(--accent-yellow);
        background: rgba(245, 158, 11, 0.12);
        color: var(--accent-yellow);
      }

      .news-header-row2 {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .search-wrap {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1 1 440px;
        min-width: 240px;
      }

      .search-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: calc(13px * var(--news-font-scale));
        outline: none;
        font-weight: 700;
      }

      .search-input:focus {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px var(--focus-ring);
      }

      .search-hint {
        font-size: calc(11px * var(--news-font-scale));
        color: var(--news-text-muted);
        white-space: nowrap;
        font-weight: 700;
      }

      .filters-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .news-chip {
        font-size: calc(12px * var(--news-font-scale));
        font-weight: 900;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border-color);
        background: rgba(59, 130, 246, 0.06);
        color: var(--text-primary);
        line-height: 1;
        user-select: none;
        cursor: pointer;
        transition: all var(--anim);
      }

      .news-chip:hover {
        border-color: var(--accent-blue);
      }

      .news-chip.active {
        border-color: var(--accent-yellow);
        background: rgba(245, 158, 11, 0.16);
        color: var(--accent-yellow);
      }

      .badge-new {
        font-size: calc(11px * var(--news-font-scale));
        font-weight: 900;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid var(--border-color);
        background: rgba(59, 130, 246, 0.12);
        color: var(--accent-blue);
        line-height: 1.2;
        user-select: none;
      }

      .news-list {
        list-style: none;
        padding: 10px 12px 12px;
        overflow: auto;
        flex: 1 1 auto;
        min-height: 0;
        background: var(--bg-secondary);
      }

      .news-item {
        padding: 10px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        margin-bottom: 10px;
        transition: all var(--anim);
      }

      .news-item:hover {
        border-color: var(--border-light);
      }

      .news-title-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .news-title-row a {
        color: var(--accent-blue);
        text-decoration: none;
        font-weight: 900;
        font-size: calc(15px * var(--news-font-scale));
        line-height: 1.3;
      }

      .news-meta {
        font-size: calc(11px * var(--news-font-scale));
        color: var(--news-text-muted);
        background: var(--bg-secondary);
        padding: 3px 8px;
        border-radius: 999px;
        line-height: 1.2;
        font-weight: 800;
      }

      .news-desc {
        margin-top: 7px;
        font-size: calc(14px * var(--news-font-scale));
        color: var(--news-text-secondary);
        line-height: 1.45;
        font-weight: 600;
      }

      .star-btn {
        margin-left: auto;
        border: 1px solid var(--border-color);
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border-radius: 12px;
        padding: 7px 10px;
        cursor: pointer;
        transition: all var(--anim);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
      }

      .star-btn:hover {
        border-color: var(--accent-yellow);
        color: var(--text-primary);
      }

      .star-btn.active {
        border-color: var(--accent-yellow);
        color: var(--accent-yellow);
        background: rgba(245, 158, 11, 0.12);
      }

      .star-btn svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
      }

      .star-btn.active svg {
        fill: currentColor;
      }

      .news-container.rtl {
        direction: rtl;
        text-align: right;
        font-family: "Inter", system-ui, -apple-system, "Noto Naskh Arabic", "Noto Sans Arabic", sans-serif;
      }
      .news-container.rtl .news-title-row {
        justify-content: flex-start;
      }
      .news-container.rtl .news-title-row a,
      .news-container.rtl .news-desc {
        text-align: right;
      }
      .news-container.rtl .news-meta {
        direction: ltr;
        unicode-bidi: plaintext;
      }
      .news-container.rtl .star-btn {
        margin-left: 0;
        margin-right: auto;
      }

      /* Heatmap */
      .heatmap-wrap {
        height: 100%;
        width: 100%;
        padding: 12px;
        background: var(--bg-secondary);
      }

      #heatmapWidget {
        height: 100%;
        width: 100%;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        overflow: hidden;
      }

      #heatmapWidget .tradingview-widget-container {
        height: 100%;
        width: 100%;
      }

      /* Modals */
      #chartModal,
      #tfChartModal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        padding: 15px;
      }

      .modal-container {
        width: 100%;
        height: 100%;
        background: var(--bg-secondary);
        border-radius: 10px;
        border: 1px solid var(--border-color);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
      }

      .modal-title {
        font-size: 14px;
        font-weight: 800;
      }

      .modal-close {
        width: 28px;
        height: 28px;
        border: none;
        border-radius: 8px;
        background: var(--accent-red);
        color: white;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all var(--anim);
      }

      .modal-body {
        flex: 1;
        display: flex;
        min-height: 0;
      }

      .modal-left {
        flex: 1;
        border-right: 1px solid var(--border-color);
        position: relative;
      }

      .modal-right {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .modal-right-top,
      .modal-right-bottom {
        flex: 1;
        position: relative;
      }

      .modal-right-top {
        border-bottom: 1px solid var(--border-color);
      }

      .modal-single {
        flex: 1;
        position: relative;
        min-height: 0;
      }

      /* ===================== Preloader ===================== */
      .preloader {
        position: fixed;
        inset: 0;
        z-index: 99999;
        background: linear-gradient(135deg, #0a0e17 0%, #111827 50%, #0a0e17 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: opacity 0.6s ease, visibility 0.6s ease;
      }

      [data-theme="light"] .preloader {
        background: linear-gradient(135deg, #f3f4f6 0%, #ffffff 50%, #f3f4f6 100%);
      }

      [data-theme="light"] .preloader-title {
        background: linear-gradient(90deg, #3b82f6, #8b5cf6, #3b82f6);
        background-size: 200% 100%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      [data-theme="light"] .preloader-subtitle {
        color: #6b7280;
      }

      .preloader.hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }

      .preloader-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 34px;
        padding: 0 16px;
        width: min(520px, 92vw);
      }

      .preloader-logo {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        text-align: center;
      }

      .preloader-icon {
        width: 80px;
        height: 80px;
        position: relative;
      }

      .preloader-icon svg {
        width: 100%;
        height: 100%;
        stroke: var(--accent-blue);
        fill: none;
        stroke-width: 1.5;
        filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.5));
      }

      .preloader-icon::before {
        content: "";
        position: absolute;
        inset: -10px;
        border-radius: 50%;
        border: 2px solid transparent;
        border-top-color: var(--accent-blue);
        border-right-color: var(--accent-purple);
        animation: preloader-spin 2s linear infinite;
      }

      @keyframes preloader-spin {
        to {
          transform: rotate(360deg);
        }
      }

      .preloader-title {
        font-size: 28px;
        font-weight: 800;
        background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple), var(--accent-blue));
        background-size: 200% 100%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: gradient-shift 3s ease infinite;
      }

      @keyframes gradient-shift {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      .preloader-subtitle {
        font-size: 14px;
        color: var(--text-muted);
        letter-spacing: 2px;
        text-transform: uppercase;
      }

      .preloader-progress {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .progress-bar-container {
        width: 100%;
        height: 6px;
        background: var(--bg-tertiary);
        border-radius: 3px;
        overflow: hidden;
        position: relative;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }

      .progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
        border-radius: 3px;
        transition: width 0.12s linear;
        position: relative;
      }

      .progress-bar::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.26), transparent);
        animation: shimmer 1.5s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .progress-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }

      .progress-percentage {
        font-size: 34px;
        font-weight: 900;
        color: var(--text-primary);
        font-variant-numeric: tabular-nums;
        display: flex;
        align-items: baseline;
        gap: 4px;
      }

      .progress-percentage span:last-child {
        font-size: 18px;
        color: var(--text-muted);
      }

      .progress-timer {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
        min-width: 160px;
      }

      .timer-value {
        font-size: 18px;
        font-weight: 900;
        color: var(--accent-blue);
        font-variant-numeric: tabular-nums;
      }

      .timer-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 800;
      }

      .preloader-steps {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
      }

      .step-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        color: var(--text-muted);
        opacity: 0.35;
        transition: all 0.25s ease;
        font-weight: 700;
      }

      .step-item.active {
        opacity: 1;
        color: var(--text-secondary);
      }

      .step-item.completed {
        opacity: 1;
        color: var(--accent-green);
      }

      .step-icon {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid currentColor;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        flex-shrink: 0;
      }

      .step-item.active .step-icon {
        border-color: var(--accent-blue);
        animation: pulse-step 1s ease infinite;
      }

      .step-item.completed .step-icon {
        background: var(--accent-green);
        border-color: var(--accent-green);
      }

      .step-item.completed .step-icon::after {
        content: "✓";
        color: white;
        font-weight: bold;
      }

      @keyframes pulse-step {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
        }
        50% {
          box-shadow: 0 0 0 6px rgba(59, 130, 246, 0);
        }
      }

      .preloader-particles {
        position: absolute;
        inset: 0;
        overflow: hidden;
        pointer-events: none;
      }

      .particle {
        position: absolute;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        opacity: 0.3;
        animation: float-particle 8s infinite ease-in-out;
      }

      @keyframes float-particle {
        0%,
        100% {
          transform: translateY(0) translateX(0);
          opacity: 0.3;
        }
        25% {
          transform: translateY(-30px) translateX(10px);
          opacity: 0.6;
        }
        50% {
          transform: translateY(-50px) translateX(-10px);
          opacity: 0.3;
        }
        75% {
          transform: translateY(-30px) translateX(15px);
          opacity: 0.5;
        }
      }

      .preloader-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        width: 100%;
      }

      .preloader-skip {
        padding: 9px 12px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        background: rgba(17, 24, 39, 0.5);
        color: var(--text-primary);
        cursor: pointer;
        font-size: 12px;
        font-weight: 900;
        transition: all var(--anim);
      }
      [data-theme="light"] .preloader-skip {
        background: rgba(255, 255, 255, 0.7);
      }
      .preloader-skip:hover {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px var(--focus-ring);
      }

      /* ===================== Mobile layout (bottom bar + vertical charts) ===================== */
      @media (max-width: 768px) {
        .topbar {
          padding-right: 0; /* no right dock on mobile */
        }

        /* Bottom bar */
        .dock {
          left: 0;
          right: 0;
          bottom: 0;
          top: auto;
          width: 100%;
          height: var(--dock-h);
          border-left: none;
          border-top: 1px solid var(--border-color);
          flex-direction: row;
          align-items: center;
          padding: 6px 8px;
          gap: 8px;
        }

        .dock-section {
          flex-direction: row;
          align-items: center;
          gap: 6px;
        }

        .dock-section + .dock-section {
          margin-top: 0;
          padding-top: 0;
          border-top: none;
          margin-left: auto;
          padding-left: 8px;
          border-left: 1px solid var(--border-color);
        }

        .dock-sep {
          width: 1px;
          height: 24px;
          margin: 0 4px;
        }

        .dock-btn {
          width: 42px;
          height: 42px;
          aspect-ratio: auto;
          border-radius: 10px;
        }

        .dock-tooltip {
          display: none; /* hover tooltips not helpful on mobile */
        }

        .mobile-only {
          display: inline-flex;
        }

        main {
          right: 0;
          bottom: var(--dock-h); /* make room for bottom bar */
        }

        /* Panel covers full width and respects bottom bar */
        .panel {
          right: 0;
          width: 100%;
          min-width: 0;
          height: calc(100vh - var(--topbar-height) - var(--dock-h));
        }

        /* Each symbol becomes a full-screen section (minus top/bottom bars) */
        .chart-section {
          height: calc(100vh - var(--topbar-height) - var(--dock-h));
        }

        /* Stack the 3 charts vertically */
        .chart-row {
          flex-direction: column;
        }

        .chart-cell {
          flex: 1;
          width: 100%;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        .dock-btn,
        .watermark,
        .tf-square,
        .panel,
        .close-btn,
        .news-btn,
        .news-item,
        .tab-btn,
        .news-chip,
        .star-btn {
          transition: none !important;
        }
      }
    </style>
  </head>

  <body>
    <!-- Preloader -->
    <div class="preloader" id="preloader" role="status" aria-live="polite">
      <div class="preloader-particles" id="particles"></div>
      <div class="preloader-content">
        <div class="preloader-logo">
          <div class="preloader-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="22 7 13.5 15.5 8.5 10.5 2 17" />
              <polyline points="16 7 22 7 22 13" />
            </svg>
          </div>
          <h1 class="preloader-title">Loading Dashboard</h1>
          <p class="preloader-subtitle">Professional Market Analysis</p>
        </div>

        <div class="preloader-progress">
          <div class="progress-info">
            <div class="progress-percentage">
              <span id="percentValue">0</span><span>%</span>
            </div>
            <div class="progress-timer">
              <div class="timer-value" id="timerValue">15</div>
              <div class="timer-label">seconds remaining</div>
            </div>
          </div>
          <div class="progress-bar-container" aria-hidden="true">
            <div class="progress-bar" id="progressBar"></div>
          </div>
        </div>

        <div class="preloader-steps" aria-label="Loading steps">
          <div class="step-item" data-step="1">
            <div class="step-icon"></div>
            <span>Initializing trading engine...</span>
          </div>
          <div class="step-item" data-step="2">
            <div class="step-icon"></div>
            <span>Rendering chart grid...</span>
          </div>
          <div class="step-item" data-step="3">
            <div class="step-icon"></div>
            <span>Connecting to market tickers...</span>
          </div>
          <div class="step-item" data-step="4">
            <div class="step-icon"></div>
            <span>Scheduling chart widgets...</span>
          </div>
          <div class="step-item" data-step="5">
            <div class="step-icon"></div>
            <span>Final checks...</span>
          </div>
        </div>

        <div class="preloader-actions">
          <button class="preloader-skip" id="preloaderSkip" type="button" aria-label="Skip preloader">
            Skip (Esc)
          </button>
        </div>
      </div>
    </div>

    <!-- Top Bar -->
    <div class="topbar">
      <div class="ticker-viewport" id="tickerViewport">
        <div class="ticker-strip" id="tickerStrip" role="list" aria-label="Market tickers">
          <div class="ticker-loading">
            <div class="ticker-loading-spinner"></div>
            <span>Loading tickers...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Dock / Bottom bar -->
    <aside class="dock" id="dock" aria-label="Tools dock">
      <div class="dock-section">
        <button class="dock-btn" id="themeToggle" type="button" title="Toggle Theme" aria-label="Toggle theme" data-action="theme">
          <svg class="icon" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="5"></circle>
            <path
              d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
            ></path>
          </svg>
          <div class="dock-tooltip">Theme</div>
        </button>

        <div class="dock-sep"></div>

        <button class="dock-btn" type="button" data-panel="calendar" title="Calendar" aria-label="Open calendar panel">
          <svg class="icon" viewBox="0 0 24 24">
            <rect x="3" y="4" width="18" height="18" rx="2"></rect>
            <path d="M16 2v4M8 2v4M3 10h18"></path>
          </svg>
          <div class="dock-tooltip">Calendar</div>
        </button>

        <button class="dock-btn" type="button" data-panel="news" title="News" aria-label="Open news panel">
          <svg class="icon" viewBox="0 0 24 24">
            <path
              d="M4 22h16a2 2 0 002-2V4a2 2 0 00-2-2H8a2 2 0 00-2 2v16a2 2 0 01-2 2zm0 0a2 2 0 01-2-2v-9c0-1.1.9-2 2-2h2"
            ></path>
            <path d="M10 6h8M10 10h8M10 14h4"></path>
          </svg>
          <div class="dock-tooltip">News</div>
        </button>

        <button class="dock-btn" type="button" data-panel="heatmap" title="Forex Heatmap" aria-label="Open forex heatmap panel">
          <svg class="icon" viewBox="0 0 24 24">
            <path
              d="M12 2s2.8 3 2.8 6.2c0 1.4-.6 2.6-1.4 3.5-.9 1-2 1.9-2 3.6 0 1.7 1.3 3 3 3 2.6 0 4.6-2.2 4.6-5.1 0-2.2-1.1-4-2.5-5.6"
            ></path>
            <path
              d="M10.4 7.2S7.6 9.8 7.6 13c0 2.9 2 5 4.7 5 1.9 0 3.4-1.4 3.4-3.3 0-1.3-.7-2.2-1.5-3.1-.7-.8-1.4-1.6-1.4-2.8"
            ></path>
          </svg>
          <div class="dock-tooltip">Heatmap</div>
        </button>
      </div>

      <div class="dock-section">
        <button class="dock-btn" type="button" data-action="refresh" title="Refresh" aria-label="Refresh page" id="refreshBtn">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M23 4v6h-6M1 20v-6h6"></path>
            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
          </svg>
          <div class="dock-tooltip">Refresh</div>
        </button>

        <!-- Mobile-only: symbol navigation -->
        <button
          class="dock-btn mobile-only"
          type="button"
          data-action="prevSymbol"
          title="Previous symbol"
          aria-label="Scroll to previous symbol"
        >
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M6 15l6-6 6 6"></path>
          </svg>
        </button>

        <button
          class="dock-btn mobile-only"
          type="button"
          data-action="nextSymbol"
          title="Next symbol"
          aria-label="Scroll to next symbol"
        >
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M6 9l6 6 6-6"></path>
          </svg>
        </button>
      </div>
    </aside>

    <!-- Side Panel -->
    <section id="sidePanel" class="panel" aria-label="Side panel" aria-hidden="true">
      <div class="panel-header">
        <h2 id="panelTitle" class="panel-title">
          <svg class="icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" /></svg>
          <span>Panel</span>
        </h2>
        <button id="closePanel" class="close-btn" type="button" aria-label="Close panel">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="panelBody" class="panel-body"></div>
    </section>

    <!-- Chart Modal -->
    <div id="chartModal" role="dialog" aria-modal="true" aria-label="Chart comparison modal">
      <div class="modal-container" role="document">
        <div class="modal-header">
          <div class="modal-title" id="modalSymbol">Symbol</div>
          <button class="modal-close" id="closeChartModal" type="button" aria-label="Close chart modal">×</button>
        </div>
        <div class="modal-body">
          <div class="modal-left" id="popupLeft"></div>
          <div class="modal-right">
            <div class="modal-right-top" id="popupRightTop"></div>
            <div class="modal-right-bottom" id="popupRightBottom"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Single Timeframe Chart Modal -->
    <div id="tfChartModal" role="dialog" aria-modal="true" aria-label="Single timeframe chart modal">
      <div class="modal-container" role="document">
        <div class="modal-header">
          <div class="modal-title" id="tfModalSymbol">Symbol</div>
          <button class="modal-close" id="closeTfChartModal" type="button" aria-label="Close timeframe modal">×</button>
        </div>
        <div class="modal-body">
          <div class="modal-single" id="tfPopupMain"></div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main id="mainContent"></main>

    <script>
      (() => {
        "use strict";

        /* ===================== Utilities ===================== */
        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        function safeStorageGet(key, fallback = null) {
          try {
            const v = localStorage.getItem(key);
            return v == null ? fallback : v;
          } catch {
            return fallback;
          }
        }
        function safeStorageSet(key, value) {
          try {
            localStorage.setItem(key, value);
          } catch {
            /* ignore */
          }
        }
        function safeIdFromSymbol(symbol) {
          return String(symbol).replace(/[^a-zA-Z0-9]+/g, "-").toLowerCase();
        }
        function clamp(n, min, max) {
          n = Number(n);
          if (!Number.isFinite(n)) return min;
          return Math.max(min, Math.min(max, n));
        }
        function on(el, type, handler, options) {
          if (!el) return () => {};
          el.addEventListener(type, handler, options);
          return () => {
            try {
              el.removeEventListener(type, handler, options);
            } catch {}
          };
        }
        function nowMs() {
          return performance && typeof performance.now === "function" ? performance.now() : Date.now();
        }

        /* ===================== Layout mode ===================== */
        const MOBILE_MQL = window.matchMedia ? window.matchMedia("(max-width: 768px)") : null;
        function isMobileLayout() {
          return MOBILE_MQL ? !!MOBILE_MQL.matches : window.innerWidth <= 768;
        }

        /* ===================== Constants ===================== */
        const TICKER_SYMBOLS = [
          "OANDA:EURUSD",
          "OANDA:GBPUSD",
          "OANDA:USDJPY",
          "OANDA:USDCHF",
          "OANDA:USDCAD",
          "OANDA:AUDUSD",
          "OANDA:NZDUSD",
          "OANDA:XAUUSD",
          "COINBASE:BTCUSD",
          "TVC:USOIL",
          "FOREXCOM:SPX500",
          "CAPITALCOM:DXY",
        ];

        const SYMBOLS = [
          { symbol: "OANDA:EURUSD", name: "EUR/USD" },
          { symbol: "OANDA:GBPUSD", name: "GBP/USD" },
          { symbol: "OANDA:USDJPY", name: "USD/JPY" },
          { symbol: "OANDA:USDCHF", name: "USD/CHF" },
          { symbol: "OANDA:USDCAD", name: "USD/CAD" },
          { symbol: "OANDA:AUDUSD", name: "AUD/USD" },
          { symbol: "OANDA:NZDUSD", name: "NZD/USD" },
          { symbol: "OANDA:XAUUSD", name: "XAU/USD" },
          { symbol: "COINBASE:BTCUSD", name: "BTC/USD" },
          { symbol: "TVC:USOIL", name: "US Oil" },
          { symbol: "FOREXCOM:SPX500", name: "S&P 500" },
          { symbol: "CAPITALCOM:DXY", name: "DXY" },
        ];

        const TIMEFRAMES = [
          { interval: "15", label: "15m" },
          { interval: "60", label: "1H" },
          { interval: "240", label: "4H" },
        ];

        const TV_TICKER_SCRIPT_URL = "https://widgets.tradingview-widget.com/w/en/tv-ticker-tag.js";
        const TV_TICKER_SCRIPT_ID = "tv-ticker-tag-script";

        const TV_CHART_EMBED_URL = "https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js";

        /* ===================== Theme ===================== */
        function getPreferredTheme() {
          const saved = safeStorageGet("theme", null);
          if (saved === "dark" || saved === "light") return saved;
          const mql = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)");
          return mql && mql.matches ? "dark" : "light";
        }

        document.documentElement.setAttribute("data-theme", getPreferredTheme());

        function getTheme() {
          return document.documentElement.getAttribute("data-theme") || "dark";
        }

        function updateThemeIcon() {
          const theme = getTheme();
          const btn = $("#themeToggle");
          if (!btn) return;
          btn.innerHTML =
            theme === "dark"
              ? '<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg><div class="dock-tooltip">Theme</div>'
              : '<svg class="icon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><div class="dock-tooltip">Theme</div>';
        }

        /* ===== Zoom compensation ===== */
        function syncZoomComp() {
          const dpr = window.devicePixelRatio || 1;
          const comp = clamp(1 / dpr, 0.7, 1.2);
          document.documentElement.style.setProperty("--zoom-comp", comp.toFixed(3));
          try {
            document.dispatchEvent(new CustomEvent("ui:zoomchange"));
          } catch {}
        }

        /* ===================== News font scale ===================== */
        let newsFontScale = Number(safeStorageGet("newsFontScale", "1"));
        if (!Number.isFinite(newsFontScale) || newsFontScale <= 0) newsFontScale = 1;

        function applyNewsFontScale() {
          newsFontScale = clamp(newsFontScale, 0.7, 1.8);
          document.documentElement.style.setProperty("--news-font-scale", String(newsFontScale));
          safeStorageSet("newsFontScale", String(newsFontScale));
        }
        applyNewsFontScale();

        /* ===================== Preloader (SYNCED to 15s countdown) ===================== */
        const Preloader = (() => {
          const FIXED_VISIBLE_MS = 15000;

          const pre = $("#preloader");
          const bar = $("#progressBar");
          const percent = $("#percentValue");
          const timer = $("#timerValue");
          const steps = $$(".step-item");
          const particles = $("#particles");
          const skipBtn = $("#preloaderSkip");

          let startAt = Date.now();
          let raf = 0;
          let finished = false;

          function createParticles() {
            if (!particles) return;
            particles.textContent = "";
            const particleCount = 20;
            for (let i = 0; i < particleCount; i++) {
              const p = document.createElement("div");
              p.className = "particle";
              p.style.left = `${Math.random() * 100}%`;
              p.style.top = `${Math.random() * 100}%`;
              p.style.animationDelay = `${Math.random() * 8}s`;
              p.style.animationDuration = `${6 + Math.random() * 4}s`;
              const colors = ["var(--accent-blue)", "var(--accent-purple)", "var(--accent-green)"];
              p.style.background = colors[(Math.random() * colors.length) | 0];
              particles.appendChild(p);
            }
          }

          function renderStepsByElapsed(elapsedMs) {
            const seg = FIXED_VISIBLE_MS / 5;
            const idx = clamp(Math.floor(elapsedMs / seg), 0, 4);

            steps.forEach((step, i) => {
              step.classList.remove("active", "completed");
              if (i < idx) step.classList.add("completed");
              else if (i === idx) step.classList.add("active");
            });

            if (elapsedMs >= FIXED_VISIBLE_MS) {
              steps.forEach((s) => {
                s.classList.remove("active");
                s.classList.add("completed");
              });
            }
          }

          function update() {
            if (!pre || finished) return;

            const elapsed = Date.now() - startAt;
            const remaining = Math.max(0, FIXED_VISIBLE_MS - elapsed);

            const pct = clamp((elapsed / FIXED_VISIBLE_MS) * 100, 0, 100);

            if (percent) percent.textContent = String(Math.floor(pct));
            if (bar) bar.style.width = `${pct}%`;
            if (timer) timer.textContent = String(Math.ceil(remaining / 1000));

            renderStepsByElapsed(elapsed);

            if (elapsed >= FIXED_VISIBLE_MS) finish();
            else raf = requestAnimationFrame(update);
          }

          function finish() {
            if (!pre || finished) return;
            finished = true;

            if (percent) percent.textContent = "100";
            if (bar) bar.style.width = "100%";
            if (timer) timer.textContent = "0";

            renderStepsByElapsed(FIXED_VISIBLE_MS);

            pre.classList.add("hidden");

            try {
              document.dispatchEvent(new CustomEvent("preloader:done"));
            } catch {}

            setTimeout(() => {
              try {
                pre.remove();
              } catch {}
            }, 650);
          }

          function skip() {
            finish();
          }

          function start() {
            if (!pre) return;
            createParticles();
            startAt = Date.now();
            raf = requestAnimationFrame(update);

            on(skipBtn, "click", () => skip());
            on(document, "keydown", (e) => {
              if (e.key === "Escape") skip();
            });
          }

          function setDone() {}

          return { start, setDone };
        })();

        Preloader.start();

        /* ===================== Ticker (Stable + Fit) ===================== */
        function setTickerLoading(message = "Loading tickers...") {
          const strip = $("#tickerStrip");
          if (!strip) return;
          strip.innerHTML = `<div class="ticker-loading"><div class="ticker-loading-spinner"></div><span>${message}</span></div>`;
        }
        function setTickerError(message) {
          const strip = $("#tickerStrip");
          if (!strip) return;
          strip.innerHTML = `<div class="ticker-loading"><span style="color: var(--accent-red); font-weight:800;">${message}</span></div>`;
        }

        function ensureTickerScriptOnce() {
          if (customElements.get("tv-ticker-tag")) return Promise.resolve();

          const existing = document.getElementById(TV_TICKER_SCRIPT_ID);
          if (existing) return customElements.whenDefined("tv-ticker-tag");

          return new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.id = TV_TICKER_SCRIPT_ID;
            script.type = "module";
            script.src = TV_TICKER_SCRIPT_URL;
            script.onload = () => {
              customElements.whenDefined("tv-ticker-tag").then(resolve).catch(resolve);
            };
            script.onerror = () => reject(new Error("Failed to load ticker script"));
            document.head.appendChild(script);
          });
        }

        function createTickerTags() {
          const strip = $("#tickerStrip");
          if (!strip) return;
          strip.textContent = "";
          const frag = document.createDocumentFragment();
          for (const symbol of TICKER_SYMBOLS) {
            const tag = document.createElement("tv-ticker-tag");
            tag.setAttribute("symbol", symbol);
            frag.appendChild(tag);
          }
          strip.appendChild(frag);
        }

        let fitRaf = 0;
        let lastFitTs = 0;

        function autoFitTickersNow() {
          const viewport = $("#tickerViewport");
          const strip = $("#tickerStrip");
          if (!viewport || !strip) return;
          if (strip.querySelector(".ticker-loading")) return;

          const t = nowMs();
          if (t - lastFitTs < 120) return;
          lastFitTs = t;

          strip.style.transform = "scale(1)";
          const viewportWidth = viewport.clientWidth;
          const stripWidth = strip.scrollWidth;
          if (!stripWidth || !viewportWidth) return;

          const safety = 0.985;
          const minScale = 0.6;
          const maxScale = 1.25;
          const scale = clamp((viewportWidth / stripWidth) * safety, minScale, maxScale);
          strip.style.transform = `scale(${scale})`;
        }

        function scheduleTickerFit() {
          if (fitRaf) return;
          fitRaf = requestAnimationFrame(() => {
            fitRaf = 0;
            autoFitTickersNow();
          });
        }

        function startTickerFitBursts() {
          scheduleTickerFit();
          setTimeout(scheduleTickerFit, 120);
          setTimeout(scheduleTickerFit, 350);
          setTimeout(scheduleTickerFit, 800);
          setTimeout(scheduleTickerFit, 1400);
        }

        async function initTickers() {
          try {
            setTickerLoading("Loading tickers...");
            await ensureTickerScriptOnce();
            createTickerTags();
            startTickerFitBursts();
            if (document.fonts && document.fonts.ready) {
              document.fonts.ready.then(() => startTickerFitBursts()).catch(() => {});
            }
          } catch (err) {
            setTickerError("Failed to load tickers. Click refresh to retry.");
            console.error("Ticker initialization error:", err);
          }
        }

        function refreshTickersSoft() {
          const strip = $("#tickerStrip");
          if (!strip) return;
          createTickerTags();
          startTickerFitBursts();
        }

        function bindTickerEvents() {
          const tickerStrip = $("#tickerStrip");
          if (!tickerStrip) return;

          tickerStrip.addEventListener(
            "click",
            (e) => {
              const path = typeof e.composedPath === "function" ? e.composedPath() : [];
              const host =
                path.find((n) => n && n.tagName === "TV-TICKER-TAG") ||
                (e.target && e.target.closest ? e.target.closest("tv-ticker-tag") : null);
              if (!host) return;
              const sym = host.getAttribute("symbol");
              if (sym) scrollToSymbol(sym);
            },
            { passive: true }
          );

          const viewport = $("#tickerViewport");
          if (window.ResizeObserver && viewport) {
            const ro = new ResizeObserver(() => scheduleTickerFit());
            ro.observe(viewport);
          } else {
            window.addEventListener("resize", scheduleTickerFit, { passive: true });
          }
        }

        /* ===================== Charts (lazy-load + theme-safe) ===================== */
        const ChartGrid = (() => {
          let io = null;
          const loadQueue = [];
          let queueRaf = 0;

          function enqueueCell(cell) {
            if (!cell || cell.dataset.loaded === "1") return;
            if (cell.dataset.queued === "1") return;
            cell.dataset.queued = "1";
            loadQueue.push(cell);
            pumpQueue();
          }

          function pumpQueue() {
            if (queueRaf) return;
            queueRaf = requestAnimationFrame(() => {
              queueRaf = 0;
              const BATCH = 3;
              let n = 0;
              while (loadQueue.length && n < BATCH) {
                const cell = loadQueue.shift();
                if (!cell || !cell.isConnected) continue;
                cell.dataset.queued = "0";
                if (cell.dataset.loaded === "1") continue;
                injectCellWidget(cell);
                n++;
              }
              if (loadQueue.length) pumpQueue();
            });
          }

          function clearCellWidget(cell) {
            const host = cell.querySelector(".chart-host");
            if (host) host.textContent = "";
            cell.dataset.loaded = "0";
            cell.dataset.queued = "0";
          }

          function injectCellWidget(cell) {
            const theme = getTheme();
            const symbol = cell.dataset.symbol;
            const interval = cell.dataset.interval;

            const host = cell.querySelector(".chart-host");
            if (!host) return;

            host.textContent = "";

            const widgetContainer = document.createElement("div");
            widgetContainer.className = "tradingview-widget-container";
            widgetContainer.style.cssText = "height:100%;width:100%;";

            const widgetDiv = document.createElement("div");
            widgetDiv.className = "tradingview-widget-container__widget";
            widgetDiv.style.cssText = "height:100%;width:100%;";

            const script = document.createElement("script");
            script.type = "text/javascript";
            script.src = TV_CHART_EMBED_URL;
            script.async = true;
            script.textContent = JSON.stringify({
              autosize: true,
              symbol,
              interval,
              timezone: "Etc/UTC",
              theme,
              style: "1",
              locale: "en",
              support_host: "https://www.tradingview.com",
              hide_top_toolbar: true,
              hide_side_toolbar: true,
              hide_legend: true,
              save_image: false,
              hide_volume: true,
              studies: [{ id: "MAExp@tv-basicstudies", inputs: { length: 200 } }],
            });

            widgetContainer.appendChild(widgetDiv);
            widgetContainer.appendChild(script);
            host.appendChild(widgetContainer);

            cell.dataset.loaded = "1";
            cell.dataset.theme = theme;
          }

          function buildGrid() {
            const main = $("#mainContent");
            if (!main) return;

            main.textContent = "";
            const frag = document.createDocumentFragment();

            const groupSize = isMobileLayout() ? 1 : 2;

            for (let i = 0; i < SYMBOLS.length; i += groupSize) {
              const section = document.createElement("div");
              section.className = "chart-section";
              section.id = `section-${Math.floor(i / groupSize) + 1}`;

              for (let j = 0; j < groupSize && i + j < SYMBOLS.length; j++) {
                const sym = SYMBOLS[i + j];
                const row = document.createElement("div");
                row.className = "chart-row";
                row.dataset.symbol = sym.symbol;

                const anchor = document.createElement("div");
                anchor.className = "chart-row-anchor";
                anchor.id = `anchor-${safeIdFromSymbol(sym.symbol)}`;
                row.appendChild(anchor);

                for (const tf of TIMEFRAMES) {
                  const cell = document.createElement("div");
                  cell.className = "chart-cell";
                  cell.dataset.symbol = sym.symbol;
                  cell.dataset.interval = tf.interval;
                  cell.dataset.loaded = "0";
                  cell.dataset.queued = "0";
                  cell.dataset.theme = "";

                  const watermark = document.createElement("div");
                  watermark.className = "watermark";
                  watermark.innerHTML = `${sym.name}<span class="tf">${tf.label}</span>`;
                  watermark.addEventListener("click", () => openPopup(sym.symbol, sym.name), { passive: true });

                  const tfSquare = document.createElement("div");
                  tfSquare.className = "tf-square";
                  tfSquare.textContent = tf.label;
                  tfSquare.title = `Open ${sym.name} ${tf.label}`;
                  tfSquare.addEventListener("click", (e) => {
                    e.stopPropagation();
                    openTfPopup(sym.symbol, sym.name, tf.interval, tf.label);
                  });

                  const wmRow = document.createElement("div");
                  wmRow.className = "wm-row";
                  wmRow.appendChild(watermark);
                  wmRow.appendChild(tfSquare);
                  cell.appendChild(wmRow);

                  const host = document.createElement("div");
                  host.className = "chart-host";
                  cell.appendChild(host);

                  row.appendChild(cell);
                }

                section.appendChild(row);
              }

              frag.appendChild(section);
            }

            main.appendChild(frag);
          }

          function setupObserver() {
            if (io) {
              try {
                io.disconnect();
              } catch {}
              io = null;
            }

            if (!("IntersectionObserver" in window)) {
              const cells = $$(".chart-cell[data-symbol]");
              cells.forEach((c, idx) => {
                if (idx < 6) injectCellWidget(c);
                else enqueueCell(c);
              });
              return;
            }

            io = new IntersectionObserver(
              (entries) => {
                for (const entry of entries) {
                  if (!entry.isIntersecting) continue;
                  const cell = entry.target;
                  if (cell.dataset.loaded === "1" && cell.dataset.theme !== getTheme()) {
                    clearCellWidget(cell);
                  }
                  enqueueCell(cell);
                }
              },
              {
                root: $("#mainContent"),
                rootMargin: "180px 0px 180px 0px",
                threshold: 0.12,
              }
            );

            $$(".chart-cell[data-symbol]").forEach((cell) => io.observe(cell));
          }

          function refreshThemeForVisibleCells() {
            const main = $("#mainContent");
            if (!main) return;

            const mainRect = main.getBoundingClientRect();
            const cells = $$(".chart-cell[data-symbol]");
            for (const cell of cells) {
              const rect = cell.getBoundingClientRect();
              const visible = rect.bottom > mainRect.top && rect.top < mainRect.bottom;
              if (!visible) continue;
              if (cell.dataset.loaded === "1" && cell.dataset.theme !== getTheme()) {
                clearCellWidget(cell);
                enqueueCell(cell);
              }
            }
          }

          function rebuildWithPreservedScroll() {
            const main = $("#mainContent");
            const scrollTop = main ? main.scrollTop : 0;
            buildGrid();
            setupObserver();
            if (main) main.scrollTop = scrollTop;
            refreshThemeForVisibleCells();
          }

          return {
            build: rebuildWithPreservedScroll,
            setupObserver,
            refreshVisible: refreshThemeForVisibleCells,
          };
        })();

        /* ===================== Panel Management (leak-free) ===================== */
        const Panel = (() => {
          const panel = $("#sidePanel");
          const panelTitle = $("#panelTitle");
          const panelBody = $("#panelBody");

          let currentKey = null;
          let cleanupFn = null;

          const content = {
            calendar: {
              title: "Calendar",
              icon: '<svg class="icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
              html: `
                <div class="calendar-container" id="calendarRoot">
                  <div class="calendar-section"><div id="economic-calendar-widget"></div></div>
                  <div class="sessions-section" id="sessionsSection">
                    <div id="localClock" class="local-clock"></div>
                    <div id="sessionContainer"></div>
                    <div class="hour-labels" id="hourLabels"></div>
                  </div>
                </div>
              `,
              init: initCalendarPanel,
            },
            news: {
              title: "News",
              icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M4 22h16a2 2 0 002-2V4a2 2 0 00-2-2H8a2 2 0 00-2 2v16a2 2 0 01-2 2zm0 0a2 2 0 01-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M10 6h8M10 10h8M10 14h4"/></svg>',
              html: `
                <div class="news-container" id="newsContainer">
                  <div class="news-header">
                    <div class="news-header-row1">
                      <div class="news-tabs" id="newsTabs" aria-label="News tabs">
                        <button class="tab-btn" type="button" data-tab="news">News</button>
                        <button class="tab-btn" type="button" data-tab="forex">Forex</button>
                        <button class="tab-btn" type="button" data-tab="crypto">Crypto</button>
                        <button class="tab-btn" type="button" data-tab="arabic">Arabic</button>
                      </div>

                      <div class="news-status-pill" id="newsStatusWrap" aria-live="polite">
                        <span id="newsStatusText">Loading...</span>
                      </div>

                      <div class="news-controls">
                        <button id="favOnly" class="news-btn" type="button" title="Show favorites only" aria-label="Toggle favorites only">★ Fav</button>
                        <button id="newOnly" class="news-btn" type="button" title="Show NEW only (last 6h)" aria-label="Toggle new-only">NEW</button>
                        <button id="fontDown" class="news-btn" type="button" title="Decrease font" aria-label="Decrease font">A-</button>
                        <button id="fontUp" class="news-btn" type="button" title="Increase font" aria-label="Increase font">A+</button>
                        <button id="refreshNews" class="news-btn" type="button" aria-label="Refresh news">↻ Refresh</button>
                      </div>
                    </div>

                    <div class="news-header-row2" aria-label="Search and filters">
                      <div class="search-wrap">
                        <input
                          id="newsSearch"
                          class="search-input"
                          type="text"
                          placeholder="Filter: EURUSD, Gold, CPI, Powell… (comma-separated)"
                          autocomplete="off"
                          spellcheck="false"
                        />
                        <span class="search-hint" id="searchHint">Tip: multiple terms = AND</span>
                      </div>

                      <div class="filters-wrap" id="sourceFilters" aria-label="Source filters"></div>
                    </div>
                  </div>

                  <ul id="newsList" class="news-list" aria-label="News list"></ul>
                </div>
              `,
              init: initNewsPanel,
            },
            heatmap: {
              title: "Forex Heatmap",
              icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M12 2s2.8 3 2.8 6.2c0 1.4-.6 2.6-1.4 3.5-.9 1-2 1.9-2 3.6 0 1.7 1.3 3 3 3 2.6 0 4.6-2.2 4.6-5.1 0-2.2-1.1-4-2.5-5.6"/><path d="M10.4 7.2S7.6 9.8 7.6 13c0 2.9 2 5 4.7 5 1.9 0 3.4-1.4 3.4-3.3 0-1.3-.7-2.2-1.5-3.1-.7-.8-1.4-1.6-1.4-2.8"/></svg>',
              html: `<div class="heatmap-wrap"><div id="heatmapWidget"></div></div>`,
              init: initHeatmapPanel,
            },
          };

          function setOpen(isOpen) {
            if (!panel) return;
            panel.classList.toggle("open", isOpen);
            panel.setAttribute("aria-hidden", String(!isOpen));
          }

          function close() {
            try {
              if (typeof cleanupFn === "function") cleanupFn();
            } catch {}
            cleanupFn = null;

            setOpen(false);
            currentKey = null;
            for (const b of $$(".dock-btn[data-panel]")) b.classList.remove("active");
          }

          function open(key) {
            const data = content[key];
            if (!data || !panel || !panelTitle || !panelBody) return;

            if (currentKey === key) {
              close();
              return;
            }

            try {
              if (typeof cleanupFn === "function") cleanupFn();
            } catch {}
            cleanupFn = null;

            setOpen(true);

            panelTitle.innerHTML = `${data.icon}<span>${data.title}</span>`;
            panelBody.innerHTML = data.html;
            currentKey = key;

            for (const b of $$(".dock-btn[data-panel]")) {
              b.classList.toggle("active", b.dataset.panel === key);
            }

            cleanupFn = typeof data.init === "function" ? data.init() : null;
          }

          function isOpenKey(key) {
            return currentKey === key && panel && panel.classList.contains("open");
          }

          function current() {
            return currentKey;
          }

          return { open, close, isOpenKey, current };
        })();

        /* ===================== Dock bindings ===================== */
        function toggleTheme() {
          const current = getTheme();
          const next = current === "dark" ? "light" : "dark";
          document.documentElement.setAttribute("data-theme", next);
          safeStorageSet("theme", next);
          updateThemeIcon();

          ChartGrid.refreshVisible();

          const cur = Panel.current();
          if (cur === "heatmap" || cur === "calendar") {
            Panel.open(cur);
            Panel.open(cur);
          }

          refreshTickersSoft();
        }

        function bindDock() {
          const dock = $("#dock");
          if (!dock) return;

          dock.addEventListener("click", (e) => {
            const btn = e.target.closest(".dock-btn");
            if (!btn) return;

            if (btn.dataset.panel) {
              Panel.open(btn.dataset.panel);
              return;
            }
            if (btn.dataset.action === "refresh") {
              location.reload();
              return;
            }
            if (btn.dataset.action === "theme") {
              toggleTheme();
              return;
            }
            if (btn.dataset.action === "prevSymbol") {
              scrollToAdjacentSymbol(-1);
              return;
            }
            if (btn.dataset.action === "nextSymbol") {
              scrollToAdjacentSymbol(1);
              return;
            }
          });

          $("#closePanel")?.addEventListener("click", () => Panel.close());

          updateThemeIcon();
        }

        /* ===================== Calendar panel (dynamic to zoom) ===================== */
        let fxVerifyScriptLoaded = false;
        let fxVerifyScriptLoading = false;

        function loadFxVerifyScript(cb) {
          if (fxVerifyScriptLoaded) return void cb();
          if (fxVerifyScriptLoading) {
            const t = setInterval(() => {
              if (fxVerifyScriptLoaded) {
                clearInterval(t);
                cb();
              }
            }, 50);
            return;
          }
          fxVerifyScriptLoading = true;

          const existing = document.getElementById("fxVerifyCalendarScript");
          if (existing) {
            fxVerifyScriptLoaded = true;
            fxVerifyScriptLoading = false;
            cb();
            return;
          }

          const script = document.createElement("script");
          script.id = "fxVerifyCalendarScript";
          script.src = "https://fxverify.com/Content/remote/remote-calendar-widget.js";
          script.onload = () => {
            fxVerifyScriptLoaded = true;
            fxVerifyScriptLoading = false;
            cb();
          };
          script.onerror = () => {
            fxVerifyScriptLoading = false;
          };
          document.head.appendChild(script);
        }

        function setCalendarSessionsHeight(px) {
          const v = clamp(px, 140, 420);
          document.documentElement.style.setProperty("--calendar-sessions-h", `${Math.round(v)}px`);
        }

        function initCalendarPanel() {
          const disposers = [];
          const add = (fn) => disposers.push(fn);

          let sessionsInterval = 0;
          let clockInterval = 0;

          const sessions = [
            { id: "sydney", name: "Sydney", startUTC: 22, endUTC: 7, timezone: "Australia/Sydney" },
            { id: "tokyo", name: "Tokyo", startUTC: 0, endUTC: 9, timezone: "Asia/Tokyo" },
            { id: "london", name: "London", startUTC: 8, endUTC: 16, timezone: "Europe/London" },
            { id: "newyork", name: "New York", startUTC: 13, endUTC: 22, timezone: "America/New_York" },
          ];

          function isForexMarketOpenUtc(now = new Date()) {
            const day = now.getUTCDay();
            const hour = now.getUTCHours() + now.getUTCMinutes() / 60;
            if (day === 6) return false;
            if (day === 0 && hour < 22) return false;
            if (day === 5 && hour >= 22) return false;
            return true;
          }

          function isSessionOpen(session, now = new Date()) {
            const utcHour = now.getUTCHours() + now.getUTCMinutes() / 60;
            if (session.startUTC > session.endUTC) return utcHour >= session.startUTC || utcHour < session.endUTC;
            return utcHour >= session.startUTC && utcHour < session.endUTC;
          }

          function getLocalTime(tz) {
            return new Date().toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
              hour12: false,
              timeZone: tz,
            });
          }

          function renderClock() {
            const clock = $("#localClock");
            if (!clock) return;
            clock.textContent = new Date().toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", hour12: true });
          }

          function renderHourLabels() {
            const container = $("#hourLabels");
            if (!container) return;
            container.textContent = "";
            for (let i = 0; i <= 24; i += 4) {
              const span = document.createElement("span");
              span.textContent = String(i % 24).padStart(2, "0");
              container.appendChild(span);
            }
          }

          function getSessionLocalHours(session, now = new Date()) {
            const y = now.getUTCFullYear();
            const m = now.getUTCMonth();
            const d = now.getUTCDate();

            const startUtc = new Date(Date.UTC(y, m, d, session.startUTC, 0, 0));
            let endUtc = new Date(Date.UTC(y, m, d, session.endUTC, 0, 0));
            if (session.startUTC > session.endUTC) endUtc = new Date(Date.UTC(y, m, d + 1, session.endUTC, 0, 0));

            const startLocal = startUtc.getHours() + startUtc.getMinutes() / 60;
            const endLocal = endUtc.getHours() + endUtc.getMinutes() / 60;

            const start = ((startLocal % 24) + 24) % 24;
            const end = ((endLocal % 24) + 24) % 24;

            return { start, end };
          }

          function renderSessions() {
            const container = $("#sessionContainer");
            if (!container) return;
            container.textContent = "";

            const now = new Date();
            const marketOpen = isForexMarketOpenUtc(now);

            for (const session of sessions) {
              const open = marketOpen && isSessionOpen(session, now);
              const localTime = getLocalTime(session.timezone);
              const { start, end } = getSessionLocalHours(session, now);

              const row = document.createElement("div");
              row.className = "session-row";

              const label = document.createElement("div");
              label.className = "session-label";

              const name = document.createElement("span");
              name.textContent = session.name;

              const time = document.createElement("span");
              time.className = "time";
              time.textContent = localTime;

              label.appendChild(name);
              label.appendChild(time);

              const barContainer = document.createElement("div");
              barContainer.className = "session-bar-container";

              const startPercent = (start / 24) * 100;
              const endPercent = (end / 24) * 100;

              if (start > end) {
                const a = document.createElement("div");
                a.className = `session-bar ${session.id} ${open ? "" : "inactive"}`;
                a.style.cssText = `left:${startPercent}%;width:${100 - startPercent}%;border-radius:6px 0 0 6px;`;
                const b = document.createElement("div");
                b.className = `session-bar ${session.id} ${open ? "" : "inactive"}`;
                b.style.cssText = `left:0;width:${endPercent}%;border-radius:0 6px 6px 0;`;
                barContainer.appendChild(a);
                barContainer.appendChild(b);
              } else {
                const bar = document.createElement("div");
                bar.className = `session-bar ${session.id} ${open ? "" : "inactive"}`;
                bar.style.cssText = `left:${startPercent}%;width:${Math.max(0, endPercent - startPercent)}%;border-radius:6px;`;
                barContainer.appendChild(bar);
              }

              const localHour = now.getHours() + now.getMinutes() / 60;
              const markerPercent = (localHour / 24) * 100;
              const marker = document.createElement("div");
              marker.className = "time-marker";
              marker.style.left = `${markerPercent}%`;
              marker.setAttribute("data-time", now.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", hour12: false }));
              barContainer.appendChild(marker);

              row.appendChild(label);
              row.appendChild(barContainer);
              container.appendChild(row);
            }
          }

          function adjustCalendarLayout() {
            const panel = $("#sidePanel");
            const sessionsSection = $("#sessionsSection");
            const sessionContainer = $("#sessionContainer");
            const clock = $("#localClock");
            const hourLabels = $("#hourLabels");
            if (!panel || !sessionsSection || !sessionContainer) return;

            const panelBody = $("#panelBody");
            const bodyH = panelBody ? panelBody.clientHeight : panel.clientHeight;

            const minH = 140;
            const maxH = clamp(Math.floor(bodyH * 0.44), 160, 420);

            const contentNeed =
              (clock ? clock.scrollHeight : 0) +
              (hourLabels ? hourLabels.scrollHeight : 0) +
              sessionContainer.scrollHeight +
              6 +
              16;

            const ideal = clamp(contentNeed, minH, maxH);
            const ensureCalendarMin = Math.floor(bodyH * 0.45);
            const finalH = clamp(ideal, minH, Math.max(minH, bodyH - ensureCalendarMin));

            setCalendarSessionsHeight(finalH);
          }

          renderHourLabels();
          renderClock();
          renderSessions();

          adjustCalendarLayout();
          setTimeout(adjustCalendarLayout, 150);

          clockInterval = window.setInterval(renderClock, 1000);
          sessionsInterval = window.setInterval(() => {
            renderSessions();
            adjustCalendarLayout();
          }, 60000);

          add(() => clockInterval && clearInterval(clockInterval));
          add(() => sessionsInterval && clearInterval(sessionsInterval));

          const onResize = () => {
            renderHourLabels();
            adjustCalendarLayout();
          };
          window.addEventListener("resize", onResize, { passive: true });
          window.visualViewport?.addEventListener("resize", onResize, { passive: true });
          document.addEventListener("ui:zoomchange", onResize);

          add(() => window.removeEventListener("resize", onResize));
          add(() => window.visualViewport?.removeEventListener("resize", onResize));
          add(() => document.removeEventListener("ui:zoomchange", onResize));

          const theme = getTheme();
          const calContainer = $("#economic-calendar-widget");
          if (calContainer) calContainer.textContent = "";

          loadFxVerifyScript(() => {
            if (typeof RemoteCalendar !== "undefined") {
              try {
                RemoteCalendar({
                  DefaultTime: "today",
                  DefaultTheme: theme === "dark" ? "dark" : "plain",
                  Url: "https://fxverify.com",
                  SubPath: "economic-calendar",
                  IsShowEmbedButton: false,
                  DefaultCountries: "AU,CA,CH,CN,DE,FR,IT,ES,US,GB,NZ,JP,EU",
                  DefaultImpacts: "HIGH",
                  ContainerId: "economic-calendar-widget",
                });
              } catch (e) {
                console.error("RemoteCalendar init error:", e);
              }
            }
          });

          return () => {
            for (const d of disposers) {
              try {
                d();
              } catch {}
            }
          };
        }

        /* ===================== News panel (working version you provided) ===================== */
        function initNewsPanel() {
          const disposers = [];
          const add = (fn) => disposers.push(fn);

          const TAB_FEEDS = {
            news: [
              { name: "InvestingLive", kind: "News", url: "https://investinglive.com/feed/news/" },
              { name: "InvestingLive", kind: "Central Banks", url: "https://investinglive.com/feed/centralbank/" },
            ],
            forex: [
              { name: "FXStreet", kind: "News", url: "https://www.fxstreet.com/rss/news" },
              { name: "FXStreet", kind: "Analysis", url: "https://www.fxstreet.com/rss/analysis" },
            ],
            crypto: [{ name: "FXStreet", kind: "Crypto", url: "https://www.fxstreet.com/rss/crypto" }],
            arabic: [{ name: "FXStreet", kind: "News", url: "https://ar.fxstreet.com/rss/news" }],
          };

          const CACHE_TTL_MS = 55 * 1000;
          const LS_TTL_MS = 10 * 60 * 1000;
          const MAX_ITEMS_PER_FEED = 120;
          const MAX_LS_ITEMS = 240;
          const NEW_HOURS = 6;
          const CONCURRENCY = 2;

          const dateFmtWithTime = new Intl.DateTimeFormat("en-GB", {
            day: "2-digit",
            month: "2-digit",
            year: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          });

          const FAV_KEY = "newsFavorites";
          function loadFavorites() {
            try {
              const raw = safeStorageGet(FAV_KEY, "[]");
              const arr = JSON.parse(raw);
              return new Set(Array.isArray(arr) ? arr : []);
            } catch {
              return new Set();
            }
          }
          function saveFavorites(set) {
            try {
              safeStorageSet(FAV_KEY, JSON.stringify(Array.from(set)));
            } catch {}
          }

          let favorites = loadFavorites();
          let favOnly = safeStorageGet("newsFavOnly", "0") === "1";
          let newOnly = safeStorageGet("newsNewOnly", "0") === "1";

          function isFavorited(link) {
            return favorites.has(link);
          }
          function toggleFavorite(link) {
            if (!link || link === "#") return;
            if (favorites.has(link)) favorites.delete(link);
            else favorites.add(link);
            saveFavorites(favorites);
          }

          let currentTab = safeStorageGet("newsTab", "news") || "news";
          if (!TAB_FEEDS[currentTab]) currentTab = "news";

          let currentKindFilter = safeStorageGet("newsKindFilter:" + currentTab, "ALL") || "ALL";
          let currentTextFilter = safeStorageGet("newsTextFilter:" + currentTab, "") || "";

          let activeLoadToken = 0;
          const tabItemsCache = new Map();

          let intervalId = 0;
          let abort = null;

          const statusText = $("#newsStatusText");
          const list = $("#newsList");
          const sourceFilters = $("#sourceFilters");
          const input = $("#newsSearch");
          const hint = $("#searchHint");
          const favBtn = $("#favOnly");
          const newBtn = $("#newOnly");

          function setNewsRtl(isRtl) {
            const container = $("#newsContainer");
            if (!container) return;
            container.classList.toggle("rtl", !!isRtl);
            container.setAttribute("dir", isRtl ? "rtl" : "ltr");
            container.setAttribute("lang", isRtl ? "ar" : "en");
          }

          function safeUrl(url) {
            try {
              const u = new URL(url, location.href);
              if (u.protocol !== "http:" && u.protocol !== "https:") return "#";
              return u.toString();
            } catch {
              return "#";
            }
          }

          function parsePubDate(pubDateText) {
            const d = pubDateText ? new Date(pubDateText) : new Date(0);
            return Number.isNaN(d.getTime()) ? new Date(0) : d;
          }

          const htmlStripper = document.createElement("div");
          function stripHtml(html) {
            htmlStripper.innerHTML = html || "";
            return (htmlStripper.textContent || "").replace(/\s+/g, " ").trim();
          }

          function truncate(text, maxLen = 300) {
            if (!text || text.length <= maxLen) return text;
            return text.slice(0, maxLen - 1).trimEnd() + "…";
          }

          function makeItemKey(it) {
            return `${it.link}||${it.title}`.toLowerCase();
          }
          function dedupeItems(items) {
            const seen = new Set();
            const out = [];
            for (const it of items) {
              const key = makeItemKey(it);
              if (seen.has(key)) continue;
              seen.add(key);
              out.push(it);
            }
            return out;
          }
          function mergeAndSort(existing, incoming) {
            const merged = dedupeItems(existing.concat(incoming));
            merged.sort((a, b) => b.pubDate - a.pubDate);
            return merged;
          }
          function uniqFeedsByUrl(feeds) {
            const map = new Map();
            for (const f of feeds) if (!map.has(f.url)) map.set(f.url, f);
            return Array.from(map.values());
          }

          function normalizeToken(s) {
            return String(s || "")
              .toUpperCase()
              .replace(/[^A-Z0-9\u0600-\u06FF]+/g, "");
          }
          function buildSearchBlob(item) {
            return normalizeToken((item?.title || "") + " " + (item?.description || ""));
          }
          function parseTextTerms(text) {
            const raw = String(text || "").trim();
            if (!raw) return [];
            return raw
              .split(",")
              .map((x) => x.trim())
              .filter(Boolean)
              .slice(0, 12);
          }
          function matchTextTerms(item, terms) {
            if (!terms.length) return true;
            const blob = buildSearchBlob(item);
            return terms.every((t) => blob.includes(normalizeToken(t)));
          }

          function isNewItem(pubDate, hours = NEW_HOURS) {
            if (!(pubDate instanceof Date)) return false;
            const ageMs = Date.now() - pubDate.getTime();
            return ageMs >= 0 && ageMs <= hours * 60 * 60 * 1000;
          }

          function filterItems(items) {
            let out = Array.isArray(items) ? items : [];
            if (favOnly) out = out.filter((x) => isFavorited(x.link));
            if (newOnly) out = out.filter((x) => isNewItem(x.pubDate, NEW_HOURS));

            if (currentTab !== "arabic" && currentKindFilter && currentKindFilter !== "ALL") {
              out = out.filter((x) => String(x.kind || "").toLowerCase() === String(currentKindFilter).toLowerCase());
            }

            const terms = parseTextTerms(currentTextFilter);
            if (terms.length) out = out.filter((x) => matchTextTerms(x, terms));
            return out;
          }

          function syncSearchUi() {
            if (input) input.value = currentTextFilter || "";
            const terms = parseTextTerms(currentTextFilter);
            if (hint) hint.textContent = terms.length ? `Terms: ${terms.join(", ")} (AND)` : "Tip: multiple terms = AND";
          }

          function updateToggleButtons() {
            if (favBtn) favBtn.classList.toggle("toggled", favOnly);
            if (newBtn) newBtn.classList.toggle("toggled", newOnly);
          }

          function setStatus(allCount, filteredCount, completed, total, startedAt, note = "") {
            if (!statusText) return;
            const secs = startedAt ? ((Date.now() - startedAt) / 1000).toFixed(1) : "0.0";
            const online = navigator.onLine !== false;
            const net = online ? "" : " • OFFLINE";
            const extra = note ? ` • ${note}` : "";
            statusText.textContent = `${filteredCount}/${allCount} items • ${completed}/${total} feeds • ${secs}s${extra}${net}`;
          }

          function render(items) {
            if (!list) return;
            list.textContent = "";

            const frag = document.createDocumentFragment();

            for (const it of items) {
              const li = document.createElement("li");
              li.className = "news-item";

              const titleRow = document.createElement("div");
              titleRow.className = "news-title-row";

              const a = document.createElement("a");
              a.href = it.link;
              a.target = "_blank";
              a.rel = "noopener noreferrer";
              a.textContent = it.title;
              titleRow.appendChild(a);

              if (it.kind) {
                const chip = document.createElement("span");
                chip.className = "news-meta";
                chip.textContent = it.kind;
                titleRow.appendChild(chip);
              }

              if (isNewItem(it.pubDate, NEW_HOURS)) {
                const nb = document.createElement("span");
                nb.className = "badge-new";
                nb.textContent = "NEW";
                titleRow.appendChild(nb);
              }

              const meta = document.createElement("span");
              meta.className = "news-meta";
              meta.textContent = `${it.source} • ${dateFmtWithTime.format(it.pubDate)}`;
              titleRow.appendChild(meta);

              const star = document.createElement("button");
              const active = isFavorited(it.link);
              star.className = "star-btn" + (active ? " active" : "");
              star.type = "button";
              star.title = active ? "Remove from favorites" : "Add to favorites";
              star.setAttribute("aria-label", "Toggle favorite");
              star.innerHTML = `
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 17.27l5.18 3.04-1.39-5.97L20 9.24l-6.19-.53L12 3 10.19 8.71 4 9.24l4.21 5.1-1.39 5.97L12 17.27z"></path>
                </svg>
              `;
              star.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                toggleFavorite(it.link);
                if (favOnly) applyRender(false);
                else star.classList.toggle("active", isFavorited(it.link));
              });
              titleRow.appendChild(star);

              li.appendChild(titleRow);

              if (it.description) {
                const p = document.createElement("p");
                p.className = "news-desc";
                p.textContent = it.description;
                li.appendChild(p);
              }

              frag.appendChild(li);
            }

            list.appendChild(frag);
          }

          function applyRender(scrollTop = false, note = "") {
            const cached = tabItemsCache.get(currentTab);
            if (!cached || !Array.isArray(cached.items)) return;

            const filtered = filterItems(cached.items);
            render(filtered);

            setStatus(
              cached.items.length,
              filtered.length,
              cached.completedFeeds || 0,
              cached.totalFeeds || 0,
              cached.startedAt || 0,
              note
            );

            if (scrollTop && list) list.scrollTo({ top: 0, behavior: "smooth" });
          }

          function abortInFlight() {
            if (abort) {
              try {
                abort.abort();
              } catch {}
            }
            abort = null;
          }

          function lsKeyForTab(tab) {
            return `newsCache:${tab}`;
          }
          function saveTabToLocalStorage(tab, items) {
            try {
              const payload = {
                fetchedAt: Date.now(),
                items: (items || []).slice(0, MAX_LS_ITEMS).map((it) => ({
                  source: it.source,
                  kind: it.kind,
                  title: it.title,
                  link: it.link,
                  pubDateTs: it.pubDate instanceof Date ? it.pubDate.getTime() : 0,
                  description: it.description,
                })),
              };
              safeStorageSet(lsKeyForTab(tab), JSON.stringify(payload));
            } catch {}
          }
          function loadTabFromLocalStorage(tab) {
            try {
              const raw = safeStorageGet(lsKeyForTab(tab), null);
              if (!raw) return null;
              const obj = JSON.parse(raw);
              if (!obj || !Array.isArray(obj.items) || !obj.fetchedAt) return null;
              if (Date.now() - obj.fetchedAt > LS_TTL_MS) return null;
              const items = obj.items
                .map((x) => ({
                  source: x.source || "",
                  kind: x.kind || "",
                  title: x.title || "",
                  link: x.link || "#",
                  pubDate: new Date(x.pubDateTs || 0),
                  description: x.description || "",
                }))
                .filter((x) => x.title && x.pubDate instanceof Date && !Number.isNaN(x.pubDate.getTime()));
              return { fetchedAt: obj.fetchedAt, items };
            } catch {
              return null;
            }
          }

          async function fetchTextRace(url, { signal } = {}) {
            const attempts = [
              { label: "allorigins", url: "https://api.allorigins.win/raw?url=" + encodeURIComponent(url), timeoutMs: 5200 },
              { label: "codetabs", url: "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(url), timeoutMs: 5200 },
              { label: "direct", url, timeoutMs: 2500 },
            ];

            const controllers = [];
            const promises = attempts.map((a) => {
              const controller = new AbortController();
              controllers.push(controller);

              const t = setTimeout(() => {
                try {
                  controller.abort();
                } catch {}
              }, a.timeoutMs);

              const onAbort = () => {
                try {
                  controller.abort();
                } catch {}
              };

              if (signal) {
                if (signal.aborted) onAbort();
                else signal.addEventListener("abort", onAbort, { once: true });
              }

              const p = fetch(a.url, { cache: "no-store", signal: controller.signal })
                .then((res) => {
                  if (!res.ok) throw new Error(`${a.label} HTTP ${res.status}`);
                  return res.text();
                })
                .then((text) => ({ ok: true, text, label: a.label }))
                .catch((err) => ({ ok: false, err, label: a.label }))
                .finally(() => {
                  clearTimeout(t);
                  if (signal) {
                    try {
                      signal.removeEventListener("abort", onAbort);
                    } catch {}
                  }
                });

              return p;
            });

            return new Promise((resolve, reject) => {
              let pending = promises.length;
              let lastErr = null;

              promises.forEach((p) => {
                p.then((r) => {
                  if (r && r.ok) {
                    controllers.forEach((c) => {
                      try {
                        c.abort();
                      } catch {}
                    });
                    resolve(r.text);
                  } else {
                    lastErr = r?.err || lastErr;
                    pending--;
                    if (pending === 0) reject(lastErr || new Error("Failed to fetch feed"));
                  }
                });
              });
            });
          }

          async function fetchAndParseRSS(feed, signal, maxItemsPerFeed = 100) {
            const xmlText = await fetchTextRace(feed.url, { signal });
            const doc = new DOMParser().parseFromString(xmlText, "text/xml");
            if (doc.querySelector("parsererror")) throw new Error("RSS parse error");

            const nodes = Array.from(doc.querySelectorAll("item"));
            const parsed = nodes
              .map((item) => {
                const title = item.querySelector("title")?.textContent?.trim() ?? "(no title)";
                const link = safeUrl(item.querySelector("link")?.textContent?.trim() ?? "#");
                const pubDateText = item.querySelector("pubDate")?.textContent?.trim() ?? "";
                const pubDate = parsePubDate(pubDateText);

                const rawDesc =
                  item.querySelector("description")?.textContent ??
                  item.querySelector("content\\:encoded")?.textContent ??
                  "";

                const description = truncate(stripHtml(rawDesc), 300);

                return {
                  source: feed.name,
                  kind: feed.kind || "",
                  title,
                  link,
                  pubDate,
                  description,
                };
              })
              .filter((x) => x.pubDate instanceof Date && !Number.isNaN(x.pubDate.getTime()));

            parsed.sort((a, b) => b.pubDate - a.pubDate);
            return parsed.slice(0, maxItemsPerFeed);
          }

          function renderSourceFilters() {
            if (!sourceFilters) return;
            sourceFilters.textContent = "";

            if (currentTab === "arabic") return;

            const feeds = TAB_FEEDS[currentTab] || [];
            const kinds = Array.from(new Set(feeds.map((f) => f.kind).filter(Boolean)));
            if (kinds.length <= 1) return;

            const mk = (label, value) => {
              const chip = document.createElement("span");
              chip.className = "news-chip" + (currentKindFilter === value ? " active" : "");
              chip.textContent = label;
              chip.title = label;
              chip.addEventListener("click", () => {
                currentKindFilter = value || "ALL";
                safeStorageSet("newsKindFilter:" + currentTab, currentKindFilter);
                renderSourceFilters();
                applyRender(true);
              });
              return chip;
            };

            sourceFilters.appendChild(mk("All", "ALL"));
            for (const k of kinds) sourceFilters.appendChild(mk(k, k));
          }

          async function loadAndRender({ force = false } = {}) {
            const myToken = ++activeLoadToken;

            const cached = tabItemsCache.get(currentTab);
            if (!force && cached?.fetchedAt && Date.now() - cached.fetchedAt < CACHE_TTL_MS) {
              applyRender(false);
              return;
            }

            abortInFlight();
            abort = new AbortController();

            const startedAt = Date.now();
            const feeds = uniqFeedsByUrl(TAB_FEEDS[currentTab] || TAB_FEEDS.news);

            let aggregated = [];
            let completed = 0;

            tabItemsCache.set(currentTab, {
              items: [],
              completedFeeds: 0,
              totalFeeds: feeds.length,
              startedAt,
              fetchedAt: Date.now(),
            });

            renderSourceFilters();
            syncSearchUi();
            updateToggleButtons();
            setStatus(0, 0, completed, feeds.length, startedAt);

            let idx = 0;
            async function worker() {
              while (idx < feeds.length) {
                const myIdx = idx++;
                const f = feeds[myIdx];
                try {
                  const parsed = await fetchAndParseRSS(f, abort.signal, MAX_ITEMS_PER_FEED);
                  if (myToken !== activeLoadToken) return;

                  await Promise.resolve();
                  aggregated = mergeAndSort(aggregated, parsed);

                  const c = tabItemsCache.get(currentTab);
                  if (c) {
                    c.items = aggregated;
                    c.totalFeeds = feeds.length;
                    c.startedAt = startedAt;
                    c.fetchedAt = Date.now();
                  }

                  saveTabToLocalStorage(currentTab, aggregated);

                  requestAnimationFrame(() => {
                    if (myToken !== activeLoadToken) return;
                    applyRender(false);
                  });
                } catch {
                  // ignore per-feed failure
                } finally {
                  completed++;
                  if (myToken !== activeLoadToken) return;

                  const c = tabItemsCache.get(currentTab);
                  if (c) c.completedFeeds = completed;

                  const filteredCount = filterItems(aggregated).length;
                  setStatus(aggregated.length, filteredCount, completed, feeds.length, startedAt);
                }
              }
            }

            const workers = [];
            for (let i = 0; i < Math.max(1, CONCURRENCY); i++) workers.push(worker());
            await Promise.allSettled(workers);

            if (myToken !== activeLoadToken) return;

            if (!aggregated.length) {
              if (statusText) statusText.textContent = "Error: feeds did not load. Try Refresh.";
              if (list) {
                list.innerHTML = `
                  <li class="news-item">
                    <div class="news-title-row">
                      <span style="color: var(--accent-red); font-weight: 900;">No items loaded</span>
                      <span class="news-meta">Try Refresh</span>
                    </div>
                    <p class="news-desc">
                      Some RSS endpoints intermittently block browser/proxy access.
                      This build uses a fastest-wins parallel fetch strategy + cache.
                      If a feed provider is down, it will fail fast instead of “loading forever”.
                    </p>
                  </li>
                `;
              }
            }
          }

          function setActiveTab(tabKey) {
            currentTab = tabKey;
            safeStorageSet("newsTab", tabKey);

            currentTextFilter = safeStorageGet("newsTextFilter:" + currentTab, "") || "";
            if (tabKey === "arabic") currentKindFilter = "ALL";
            else currentKindFilter = safeStorageGet("newsKindFilter:" + currentTab, "ALL") || "ALL";

            setNewsRtl(tabKey === "arabic");
            if (input) {
              input.placeholder =
                tabKey === "arabic"
                  ? "فلتر: EURUSD, الذهب, CPI… (افصل بفاصلة ,)"
                  : "Filter: EURUSD, Gold, CPI, Powell… (comma-separated)";
            }

            for (const b of $$("#newsTabs .tab-btn")) b.classList.toggle("active", b.dataset.tab === tabKey);

            renderSourceFilters();
            syncSearchUi();
            updateToggleButtons();
          }

          function bindTabs() {
            const tabs = $("#newsTabs");
            if (!tabs) return;

            const off = on(
              tabs,
              "click",
              (e) => {
                const btn = e.target.closest(".tab-btn");
                if (!btn) return;
                const tab = btn.dataset.tab;
                if (!tab || tab === currentTab) return;

                setActiveTab(tab);

                const ls = loadTabFromLocalStorage(currentTab);
                if (ls && ls.items.length) {
                  tabItemsCache.set(currentTab, {
                    items: ls.items,
                    completedFeeds: 0,
                    totalFeeds: (TAB_FEEDS[currentTab] || []).length,
                    startedAt: Date.now(),
                    fetchedAt: Date.now(),
                  });
                  applyRender(false, "cached");
                }

                if (intervalId) clearInterval(intervalId);
                loadAndRender({ force: false });
                intervalId = setInterval(() => loadAndRender({ force: false }), 60000);
              },
              { passive: true }
            );
            add(off);
          }

          function bindControls() {
            add(
              on($("#refreshNews"), "click", () => {
                tabItemsCache.delete(currentTab);
                safeStorageSet(lsKeyForTab(currentTab), "");
                loadAndRender({ force: true });
              })
            );

            add(
              on($("#fontDown"), "click", () => {
                newsFontScale -= 0.1;
                applyNewsFontScale();
              })
            );

            add(
              on($("#fontUp"), "click", () => {
                newsFontScale += 0.1;
                applyNewsFontScale();
              })
            );

            add(
              on($("#favOnly"), "click", () => {
                favOnly = !favOnly;
                safeStorageSet("newsFavOnly", favOnly ? "1" : "0");
                updateToggleButtons();
                applyRender(true);
              })
            );

            add(
              on($("#newOnly"), "click", () => {
                newOnly = !newOnly;
                safeStorageSet("newsNewOnly", newOnly ? "1" : "0");
                updateToggleButtons();
                applyRender(true);
              })
            );

            if (input) {
              add(
                on(input, "input", () => {
                  currentTextFilter = input.value || "";
                  safeStorageSet("newsTextFilter:" + currentTab, currentTextFilter);
                  syncSearchUi();
                  applyRender(false);
                })
              );
            }

            add(on(window, "online", () => applyRender(false), { passive: true }));
            add(on(window, "offline", () => applyRender(false), { passive: true }));
          }

          bindTabs();
          bindControls();
          setActiveTab(currentTab);

          const initialLs = loadTabFromLocalStorage(currentTab);
          if (initialLs && initialLs.items.length) {
            tabItemsCache.set(currentTab, {
              items: initialLs.items,
              completedFeeds: 0,
              totalFeeds: (TAB_FEEDS[currentTab] || []).length,
              startedAt: Date.now(),
              fetchedAt: Date.now(),
            });
            applyRender(false, "cached");
          }

          loadAndRender({ force: false });
          intervalId = setInterval(() => loadAndRender({ force: false }), 60000);

          add(() => intervalId && clearInterval(intervalId));
          add(() => abortInFlight());

          return () => {
            for (const d of disposers) {
              try {
                d();
              } catch {}
            }
          };
        }

        /* ===================== Heatmap panel ===================== */
        function initHeatmapPanel() {
          const theme = getTheme();
          const container = $("#heatmapWidget");
          if (!container) return () => {};
          container.textContent = "";

          const wrap = document.createElement("div");
          wrap.className = "tradingview-widget-container";
          wrap.style.cssText = "height:100%;width:100%;";

          const script = document.createElement("script");
          script.type = "text/javascript";
          script.src = "https://s3.tradingview.com/external-embedding/embed-widget-forex-heat-map.js";
          script.async = true;

          const isLight = theme === "light";
          script.textContent = JSON.stringify({
            colorTheme: isLight ? "light" : "dark",
            isTransparent: false,
            locale: "en",
            support_host: "https://www.tradingview.com",
            currencies: ["EUR", "USD", "JPY", "GBP", "CHF", "AUD", "CAD", "NZD"],
            backgroundColor: isLight ? "#ffffff" : "#111827",
            width: "100%",
            height: "100%",
          });

          wrap.appendChild(script);
          container.appendChild(wrap);

          return () => {};
        }

        /* ===================== Modals ===================== */
        function injectWidget(containerId, symbol, interval, theme) {
          const container = document.getElementById(containerId);
          if (!container) return;
          container.textContent = "";

          const widgetContainer = document.createElement("div");
          widgetContainer.className = "tradingview-widget-container";
          widgetContainer.style.cssText = "height:100%;width:100%;";

          const widgetDiv = document.createElement("div");
          widgetDiv.className = "tradingview-widget-container__widget";
          widgetDiv.style.cssText = "height:100%;width:100%;";

          const script = document.createElement("script");
          script.type = "text/javascript";
          script.src = TV_CHART_EMBED_URL;
          script.async = true;

          script.textContent = JSON.stringify({
            autosize: true,
            symbol,
            interval,
            timezone: "Etc/UTC",
            theme,
            style: "1",
            locale: "en",
            support_host: "https://www.tradingview.com",
            hide_top_toolbar: false,
            hide_side_toolbar: false,
            hide_legend: false,
            allow_symbol_change: true,
            save_image: false,
            calendar: false,
            hide_volume: true,
            studies: [{ id: "MAExp@tv-basicstudies", inputs: { length: 200 } }],
          });

          widgetContainer.appendChild(widgetDiv);
          widgetContainer.appendChild(script);
          container.appendChild(widgetContainer);
        }

        function openPopup(symbol, name) {
          $("#modalSymbol").textContent = name || symbol;
          const theme = getTheme();
          injectWidget("popupLeft", symbol, "15", theme);
          injectWidget("popupRightTop", symbol, "60", theme);
          injectWidget("popupRightBottom", symbol, "240", theme);
          $("#chartModal").style.display = "block";
        }

        function closePopup() {
          const modal = $("#chartModal");
          if (modal) modal.style.display = "none";
          for (const id of ["popupLeft", "popupRightTop", "popupRightBottom"]) {
            const el = document.getElementById(id);
            if (el) el.textContent = "";
          }
        }

        function openTfPopup(symbol, name, interval, tfLabel) {
          const theme = getTheme();
          $("#tfModalSymbol").textContent = `${name || symbol} • ${tfLabel || interval}`;
          injectWidget("tfPopupMain", symbol, interval, theme);
          $("#tfChartModal").style.display = "block";
        }

        function closeTfPopup() {
          const modal = $("#tfChartModal");
          if (modal) modal.style.display = "none";
          const el = $("#tfPopupMain");
          if (el) el.textContent = "";
        }

        function bindModalClose() {
          const chartModal = $("#chartModal");
          const tfModal = $("#tfChartModal");

          $("#closeChartModal")?.addEventListener("click", closePopup);
          $("#closeTfChartModal")?.addEventListener("click", closeTfPopup);

          chartModal?.addEventListener("click", (e) => {
            if (e.target === chartModal) closePopup();
          });
          tfModal?.addEventListener("click", (e) => {
            if (e.target === tfModal) closeTfPopup();
          });
        }

        window.openPopup = openPopup;
        window.closePopup = closePopup;
        window.openTfPopup = openTfPopup;
        window.closeTfPopup = closeTfPopup;

        /* ===================== Symbol scrolling (mobile arrows) ===================== */
        function scrollToSymbol(symbol) {
          const main = $("#mainContent");
          if (!main) return;
          const anchor = document.getElementById(`anchor-${safeIdFromSymbol(symbol)}`);
          if (!anchor) return;

          const mainRect = main.getBoundingClientRect();
          const anchorRect = anchor.getBoundingClientRect();
          const targetTop = main.scrollTop + (anchorRect.top - mainRect.top);
          main.scrollTo({ top: Math.max(0, targetTop - 6), behavior: "smooth" });
        }

        function getCurrentSymbolIndex() {
          const main = $("#mainContent");
          if (!main) return 0;

          const y = main.scrollTop;
          const anchors = SYMBOLS.map((s) => document.getElementById(`anchor-${safeIdFromSymbol(s.symbol)}`));

          // Choose the last anchor at/above current scroll position (top-of-view)
          let idx = 0;
          for (let i = 0; i < anchors.length; i++) {
            const a = anchors[i];
            if (!a) continue;
            const top = a.offsetTop;
            if (top <= y + 10) idx = i;
            else break;
          }
          return clamp(idx, 0, SYMBOLS.length - 1);
        }

        function scrollToAdjacentSymbol(dir) {
          const cur = getCurrentSymbolIndex();
          const next = clamp(cur + (dir < 0 ? -1 : 1), 0, SYMBOLS.length - 1);
          const sym = SYMBOLS[next]?.symbol;
          if (sym) scrollToSymbol(sym);
        }

        /* ===================== Keyboard shortcuts ===================== */
        function focusNewsSearch() {
          if (!Panel.isOpenKey("news")) {
            Panel.open("news");
          }
          requestAnimationFrame(() => {
            const input = $("#newsSearch");
            if (input) input.focus();
          });
        }

        function bindKeyboard() {
          document.addEventListener("keydown", (e) => {
            const tag = e.target && e.target.tagName ? e.target.tagName : "";
            const isTyping = tag === "INPUT" || tag === "TEXTAREA" || e.target?.isContentEditable;
            const key = String(e.key);

            if (key === "/" && !isTyping && !e.ctrlKey && !e.metaKey && !e.altKey) {
              e.preventDefault();
              focusNewsSearch();
              return;
            }

            if (isTyping) return;

            switch (key.toLowerCase()) {
              case "escape":
                closePopup();
                closeTfPopup();
                Panel.close();
                break;
              case "c":
                Panel.open("calendar");
                break;
              case "n":
                Panel.open("news");
                break;
              case "h":
                Panel.open("heatmap");
                break;
              case "t":
                toggleTheme();
                break;
              case "arrowup":
                if (isMobileLayout()) scrollToAdjacentSymbol(-1);
                break;
              case "arrowdown":
                if (isMobileLayout()) scrollToAdjacentSymbol(1);
                break;
            }
          });
        }

        /* ===================== Layout-change rebuild ===================== */
        let lastMobile = isMobileLayout();
        function handlePossibleLayoutChange() {
          const cur = isMobileLayout();
          if (cur !== lastMobile) {
            lastMobile = cur;
            ChartGrid.build();
            ChartGrid.setupObserver();
            refreshTickersSoft();
            startTickerFitBursts();
          }
        }

        /* ===================== Init ===================== */
        function init() {
          syncZoomComp();
          window.addEventListener("resize", () => {
            syncZoomComp();
            handlePossibleLayoutChange();
          }, { passive: true });
          window.visualViewport?.addEventListener("resize", () => {
            syncZoomComp();
            handlePossibleLayoutChange();
          }, { passive: true });

          bindDock();
          bindModalClose();
          bindKeyboard();
          bindTickerEvents();

          ChartGrid.build();
          ChartGrid.setupObserver();

          initTickers();

          // Refresh top bar widgets once more AFTER the preloader ends (zoom/DPR settle)
          document.addEventListener(
            "preloader:done",
            () => {
              ensureTickerScriptOnce()
                .then(() => {
                  refreshTickersSoft();
                  startTickerFitBursts();
                  setTimeout(() => startTickerFitBursts(), 600);
                })
                .catch(() => {
                  startTickerFitBursts();
                  setTimeout(() => startTickerFitBursts(), 600);
                });
            },
            { once: true }
          );

          document.addEventListener("visibilitychange", () => {
            if (!document.hidden) {
              startTickerFitBursts();
              const strip = $("#tickerStrip");
              if (strip && !strip.querySelector("tv-ticker-tag") && !strip.querySelector(".ticker-loading")) {
                refreshTickersSoft();
              }
              ChartGrid.refreshVisible();
            }
          });

          // Also listen to media query changes where supported
          if (MOBILE_MQL && typeof MOBILE_MQL.addEventListener === "function") {
            MOBILE_MQL.addEventListener("change", handlePossibleLayoutChange);
          }
        }

        init();
      })();
    </script>
  </body>
</html>
